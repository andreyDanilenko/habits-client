# Руководство по автоматическому обновлению SSL-сертификатов

## 1. Создание скрипта обновления

Создайте файл скрипта в папке проекта:

```bash
nano /root/project/deployment/renew_certs.sh
```

Вставьте следующий код (уже адаптированный под ваши пути):

```bash
#!/bin/bash

# Путь к папке проекта
PROJECT_DIR="/root/project/deployment"
SSL_DIR="$PROJECT_DIR/nginx/ssl"

echo "--- Starting certificate renewal: $(date) ---"

# 1. Останавливаем контейнеры (освобождаем 80 порт)
cd $PROJECT_DIR
docker-compose down

# 2. Продлеваем сертификаты (Certbot сам поймет, какие пора обновить)
certbot renew --standalone --key-type rsa \
  --config-dir $SSL_DIR/config \
  --work-dir $SSL_DIR/work \
  --logs-dir $SSL_DIR/logs

# 3. Обновляем файлы в папке nginx/ssl (используем cat для "физического" копирования)
# Повторите эти строки для каждого домена, если их станет больше
DOMAIN="habits.lifedream.tech"
cat $SSL_DIR/config/live/$DOMAIN/fullchain.pem > $SSL_DIR/$DOMAIN.crt
cat $SSL_DIR/config/live/$DOMAIN/privkey.pem > $SSL_DIR/$DOMAIN.key

# 4. Поправляем права доступа
chmod 644 $SSL_DIR/$DOMAIN.*

# 5. Запускаем проект обратно
docker-compose up -d

echo "--- Renewal finished ---"
```

## 2. Настройка прав доступа

Сделайте файл исполняемым:

```bash
chmod +x /root/project/deployment/renew_certs.sh
```

## 3. Добавление в планировщик Cron

Чтобы скрипт запускался автоматически (например, раз в неделю), добавьте его в crontab. Certbot автоматически проверит срок годности сертификатов и обновит только те, срок действия которых истекает менее чем через 30 дней.

Откройте планировщик заданий:

```bash
sudo crontab -e
```

(Если система предложит выбрать редактор, выберите вариант 1 для Nano)

Добавьте в конец файла следующую строку (для запуска каждый понедельник в 03:00 ночи):

```bash
0 3 * * 1 /root/project/deployment/renew_certs.sh >> /var/log/cert_renewal.log 2>&1
```

## 4. Проверка работы

Вы можете запустить скрипт вручную для проверки корректности работы:

```bash
/root/project/deployment/renew_certs.sh
```

## Дополнительная информация

- **Логирование**: Все выводы скрипта сохраняются в файл `/var/log/cert_renewal.log`
- **Частота запуска**: Настройка `0 3 * * 1` означает запуск каждый понедельник в 3:00 утра
- **Безопасность**: Certbot автоматически проверяет необходимость обновления и продлевает только истекающие сертификаты
- **Контейнеры**: Проект будет временно остановлен на время обновления сертификатов (обычно несколько секунд)

## Устранение возможных проблем

Если возникнут проблемы с правами доступа к файлам сертификатов, убедитесь, что:
1. Пользователь имеет права на чтение файлов в директории SSL
2. Файлы сертификатов существуют по указанным путям
3. Docker-контейнеры успешно останавливаются и запускаются
